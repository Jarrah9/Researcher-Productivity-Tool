{% extends "base.html" %} 
{% block head %}
<style>
  .admin-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 32px 24px;
    max-width: 600px;
    margin: 40px auto;
  }
  .admin-card h1 {
    font-size: 2em;
    margin-bottom: 24px;
  }
  .admin-card h4 {
    margin-top: 24px;
  }
  #scraper-logs {
    background-color: #212529;
    color: #f8f9fa;
    border: 1px solid #495057;
    border-radius: 4px;
    padding: 12px;
    margin-top: 16px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.875em;
    display: none;
  }
  #issn-batches-content {
    display: none;
    background: #f8f9fa;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 16px;
    margin-top: 16px;
    font-family: 'Courier New', Courier, monospace;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
  }
  .db-table th, .db-table td { vertical-align: middle; }
</style>
{% endblock %} 
{% block content %}
<div class="admin-card">
  <h1 class="mb-4">Admin Dashboard</h1>
  <div class="mb-4">
    <h4>Database Management</h4>
    <table class="table db-table mb-3">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for db in db_list %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>
            {% if db == current_db %}
              <strong>{{ db }}</strong> <span class="badge bg-primary">Current</span>
            {% else %}
              {{ db }}
            {% endif %}
          </td>
          <td>
            {% if db != current_db %}
            <form action="/admin/delete-db" method="post" style="display:inline;">
              <input type="hidden" name="db_name" value="{{ db }}">
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete database {{ db }}?')">Delete</button>
            </form>
            {% endif %}
          </td>
          <td>
            {% if db != current_db %}
            <form action="/admin/rename-db" method="post" class="d-inline-flex align-items-center">
              <input type="hidden" name="old_db_name" value="{{ db }}">
              <input type="text" name="new_db_name" class="form-control form-control-sm me-1" placeholder="New name" style="width: 100px;" required>
              <button type="submit" class="btn btn-secondary btn-sm">Rename</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr>
          <form action="/admin/create-db" method="post" class="d-flex align-items-center">
            <td colspan="2">
              <input type="text" name="new_db_name" class="form-control" placeholder="New database name" required>
            </td>
            <td colspan="2">
              <button type="submit" class="btn btn-success">Create</button>
            </td>
          </form>
        </tr>
      </tbody>
    </table>
    <form action="/admin/switch-db" method="post" class="d-flex align-items-center mb-3">
      <label for="db-select" class="me-2">Switch to:</label>
      <select id="db-select" name="db_name" class="form-select me-2" style="width: auto;">
        {% for db in db_list %}
          <option value="{{ db }}" {% if db == current_db %}selected{% endif %}>{{ db }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-primary me-2">Switch</button>
    </form>
  </div>
  <div class="mb-4">
    <h4>Upload CSV</h4>
    <div>
      <p>Note: the download button will download the data in the current selected database, and is also reprentative of the required CSV templates. You can have other columns in the CSV and they will be ignored.</p>
      <div class="mb-3">
        <h6>Master Spreadsheet</h6>
        <form class="d-flex align-items-center mt-2" action="/admin/upload/master_csv" method="post" enctype="multipart/form-data">
          <input type="file" class="form-control me-2" name="master_csv" accept=".csv">
          <button type="submit" class="btn btn-primary me-2">Upload</button>
          <a href="/admin/download/researchers.csv" class="btn btn-link">Download</a>
        </form>
      </div>
      <div class="mb-3">
        <h6>ABDC Rankings</h6>
        <form class="d-flex align-items-center" action="/admin/upload/abdc" method="post" enctype="multipart/form-data">
          <input type="file" class="form-control me-2" name="abdc_csv" accept=".csv">
          <button type="submit" class="btn btn-primary me-2">Upload</button>
          <a href="/admin/download/abdc_template.csv" class="btn btn-link">Download</a>
        </form>
      </div>
      <div class="mb-3">
        <h6>UWA Staff to Field Mappings</h6>
        <form class="d-flex align-items-center" action="/admin/upload/uwa_staff_field" method="post" enctype="multipart/form-data">
          <input type="file" class="form-control me-2" name="uwa_staff_field_csv" accept=".csv">
          <button type="submit" class="btn btn-primary me-2">Upload</button>
          <a href="/admin/download/UWA_staff_field_template.csv" class="btn btn-link">Download</a>
        </form>
      </div>
      <div class="mb-3">
        <h6>Clarivate Rankings</h6>
        <form class="d-flex align-items-center" action="/admin/upload/clarivate" method="post" enctype="multipart/form-data">
          <input type="file" class="form-control me-2" name="clarivate_csv" accept=".csv">
          <button type="submit" class="btn btn-primary me-2">Upload</button>
          <a href="/admin/download/clarivate_template.csv" class="btn btn-link">Download</a>
        </form>
        <button id="show-issn-batches" class="btn btn-secondary mt-2" type="button">Show ISSN Batches</button>
        <div id="issn-batches-content">{% if issn_batches_content %}{{ issn_batches_content }}{% endif %}</div>
      </div>
    </div>
  </div>
  {% if flash %}
    <div class="alert alert-info mt-3" role="alert">
      {{ flash|safe }}
    </div>
  {% endif %}
  <!-- This is the section for running the scraper -->
  <div class="mt-4">
    <h4>Run Scraper (Depreciated)</h4>
    <button id="run-scraper" class="btn btn-warning">Run Scraper</button>
    <div class="progress mt-2" style="display: none">
      <div
        id="scraper-progress"
        class="progress-bar"
        role="progressbar"
        style="width: 0%"
        aria-valuenow="0"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        0%
      </div>
    </div>
    <small id="scraper-message" class="form-text text-muted mt-1"></small>
    <pre id="scraper-logs"></pre>
  </div>
  <div class="mt-4">
    <form action="/logout" method="post">
      <button type="submit" class="btn btn-danger">Logout</button>
    </form>
  </div>
</div>
<script>
  document.getElementById('run-scraper').addEventListener('click', function () {
    var button = this;
    var progressBar = document.getElementById('scraper-progress');
    var progressContainer = document.querySelector('.progress');
    var messageElement = document.getElementById('scraper-message');
    var logsElement = document.getElementById('scraper-logs');

    // --- Reset UI state on click ---
    button.disabled = true;
    button.textContent = 'Scraping...';
    messageElement.textContent = '';

    progressBar.classList.remove('bg-success', 'bg-danger');
    progressBar.classList.add('bg-primary');

    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressContainer.style.display = 'block';

    logsElement.style.display = 'block';
    logsElement.textContent = 'Initializing scraper, waiting for logs...';

    // --- Start the scraper task ---
    fetch('/admin/run-scraper', { method: 'POST' })
      .then((response) => {
        if (!response.ok) {
          response.json().then((data) => {
            messageElement.textContent =
              data.message || 'Failed to start scraper.';
          });
          throw new Error('Failed to start scraper');
        }
        return response.json();
      })
      .then((data) => {
        messageElement.textContent = data.message;
        // --- Poll for progress and logs ---
        var interval = setInterval(function () {
          fetch('/admin/scraper-status')
            .then((response) => response.json())
            .then((data) => {
              var progress = data.progress;

              // Update the logs display
              if (data.logs && data.logs.length > 0) {
                logsElement.textContent = data.logs.join('\n');
                // Auto-scroll to the bottom to show the latest logs
                logsElement.scrollTop = logsElement.scrollHeight;
              }

              // Update progress bar and overall status
              if (progress < 0) {
                // Error state
                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = 'Error!';
                progressBar.classList.remove('bg-primary', 'bg-success');
                progressBar.classList.add('bg-danger');
                button.disabled = false;
                button.textContent = 'Run Scraper Again';
                messageElement.textContent = data.message || 'Scraping failed.';
              } else if (progress >= 100) {
                // Completion state
                clearInterval(interval);
                progressBar.style.width = '100%';
                progressBar.textContent = 'Completed!';
                progressBar.classList.remove('bg-primary');
                progressBar.classList.add('bg-success');
                button.disabled = false;
                button.textContent = 'Run Scraper';
                messageElement.textContent = data.message;
              } else {
                // In-progress state
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
              }
            });
        }, 2000); // Poll every 2 seconds
      })
      .catch((error) => {
        console.error('Error:', error);
        button.disabled = false;
        button.textContent = 'Run Scraper';
        logsElement.textContent =
          'Failed to start the scraper task. Check the browser console for errors.';
      });
  });

  document.addEventListener("DOMContentLoaded", function() {
    var btn = document.getElementById("show-issn-batches");
    var content = document.getElementById("issn-batches-content");
    if (btn && content) {
        btn.addEventListener("click", function() {
            if (content.style.display === "none" || content.style.display === "") {
                // If content is empty, fetch from server
                if (!content.textContent.trim()) {
                    fetch("/admin/issn_batches")
                        .then(resp => resp.text())
                        .then(html => {
                            // Parse the returned HTML and extract the issn_batches_content
                            var parser = new DOMParser();
                            var doc = parser.parseFromString(html, "text/html");
                            var newContent = doc.getElementById("issn-batches-content");
                            if (newContent) {
                                content.innerHTML = newContent.innerHTML;
                            }
                            content.style.display = "block";
                        });
                } else {
                    content.style.display = "block";
                }
            } else {
                content.style.display = "none";
            }
        });
    }
  });
</script>
{% endblock %}
